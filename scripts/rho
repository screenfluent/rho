#!/usr/bin/env bash
# rho - Start or attach to rho session
#
# Usage:
#   rho          Start daemon (if needed) and attach
#   rho -d       Start daemon in background, don't attach
#   rho status   Show status
#   rho stop     Stop daemon

# Source rho config
if [ -f "$HOME/.config/rho/config" ]; then
  . "$HOME/.config/rho/config"
fi
RHO_DIR="${RHO_DIR:-$HOME/projects/rho}"
RHO_PLATFORM="${RHO_PLATFORM:-unknown}"

SESSION_NAME="rho"
PIDFILE="$HOME/.rho-daemon.pid"

case "${1:-}" in
    status)
        rho-status
        exit $?
        ;;
    stop)
        rho-stop
        exit $?
        ;;
    -d|--daemon)
        # Start in background only
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            echo "Rho already running"
            exit 0
        fi
        nohup rho-daemon >/dev/null 2>&1 &
        sleep 1
        echo "Rho daemon started (tmux session: $SESSION_NAME)"
        exit 0
        ;;
esac

# Default: start if needed, then attach
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    # Already running, just attach
    exec tmux attach -t "$SESSION_NAME"
else
    # Android: acquire wake lock to prevent doze
    if [ "$RHO_PLATFORM" = "android" ]; then
        termux-wake-lock 2>/dev/null
    fi

    tmux new-session -d -s "$SESSION_NAME" -c "$HOME" "pi -c"

    # Android: persistent notification with actions
    if [ "$RHO_PLATFORM" = "android" ] && command -v termux-notification >/dev/null 2>&1; then
        termux-notification \
            --title "Rho" \
            --content "Session started" \
            --id rho-daemon \
            --ongoing \
            --icon smart_toy
    fi

    # Background process to monitor session and clean up
    (
        while tmux has-session -t "$SESSION_NAME" 2>/dev/null; do
            sleep 30
        done
        if [ "$RHO_PLATFORM" = "android" ]; then
            termux-wake-unlock 2>/dev/null
            termux-notification-remove rho-daemon 2>/dev/null
        fi
    ) &
    echo $! > "$PIDFILE"

    # Attach
    exec tmux attach -t "$SESSION_NAME"
fi
